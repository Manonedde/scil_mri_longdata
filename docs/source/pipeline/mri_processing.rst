MRI Processing
=================

The processing of 3DT1, DWI and ihMT images involves several pipelines (flows, using `Nextflow`_ tools) developed by `SCIL`_. The main steps of the processing are summarized in the figure below. The main steps are:


.. figure:: pipelines.jpg
   :align: center

   Figure 1. Pipelines overview.

Generate maps
   `Tractoflow`_ is used to process T1 and DWI images to generate tractograms and diffusion measurement maps derived from the DTI model and fODF. `Tractoflow`_ outputs are then used as input for the `Freewater Flow`_ to correct DWI and generate Freewater-corrected DTI model-derived measurement maps and the Freewater map.
   Similarly, the `NODDI Flow`_ is used to generate four microstructure maps computed using the `Amico`_ model.
   In parallel, ihMT images are processed with the `ihMT Flow`_ to generate the four myelin maps (2 ratios and 2 saturations, i.e. corrected for T1 dependence).

Bundles segmentation
   From the tractogram generated by `Tractoflow`_, the white matter bundles are segmented using `RecobundlesX Flow`_

Extract average measurements
   Finally, from each bundle and the diffusion and myelin maps, the mean value for the whole bundle and along the bundle is obtained using Tractometry flow.


Segmented bundles
------------------

Representation of the major white matter bundle models used by `RecobundlesX Flow`_ as shape priors to extract the bundles from the whole tractogram. Bundles of both hemispheres are shown.

.. figure:: bundles_segmentation.png
   :align: center
   :width: 700

   The Arcuate fasciculus is in dark green, the cingulum in yellow, the inferior fronto-orbital fasciculus in orange, the inferior fronto-occipital fasciculus in ligh green, the optic radiation in blue-green, the uncinate fasciculus in dark purple, the corticospinal tract in dark blue, the superior longitudinal fasciculus parts in purple gradation, the corpus callosum is represented in several color ranges.


Quality Control
---------------
The visual quality assessment procedure was applied to the main steps according to the following criteria (using `DMRI QC Flow`_):

+------------------+---------------------+-------------------------------------------------------------------+
|   MRI images     |         Step        |                        Exclusion criteria                         |
+==================+=====================+===================================================================+
|  T1, MTI, DWI    |  Raw data           | Presence of artifacts that cannot be corrected,                   |
|                  |                     | Incorrect field of view, Incorrect distribution of gradient (DWI) |
|                  |                     | Too high noise in the image, High inhomogeneity (MTI),            |
|                  |                     | Broken image, Missing part of the brain (T1, MTI)                 |
+------------------+---------------------+-------------------------------------------------------------------+
|  T1, MTI, DWI    | Brain extraction    | Eyes included in the brain mask,                                  |
|                  |                     | Exclusion of a part of the brain,                                 |
|                  |                     | Inclusion of a large part of the background in the brain mask     |
+------------------+---------------------+-------------------------------------------------------------------+
|      DWI         | Motion correction   | Alteration of bvecs,                                              |
|                  |                     | Remaining motion in the DWI,                                      |
|                  |                     | Presence of slice drop (at least in one direction)                |
+------------------+---------------------+-------------------------------------------------------------------+
|      DWI         | RGB                 | Invalid orientation in major WM structures,                       |
|                  |                     | Low FA value in expected structure (Corpus callosum for example), |
|                  |                     | Global color bias (indicating remaining motion)                   |
+------------------+---------------------+-------------------------------------------------------------------+
|  T1, MTI, DWI    | Registration        | Poor overlap between warped images and reference image            |
+------------------+---------------------+-------------------------------------------------------------------+
|     T1, DWI      | Mask                | Presence of holes in mask,                                        |
|                  |                     | Some part of mask missing                                         |
+------------------+---------------------+-------------------------------------------------------------------+
|      DWI         | Bundle segmentation | Unexpected shape,                                                 |
|                  |                     | Ends of bundle not in expected locations and/or without expected  |
|                  |                     | fanning,                                                          |
|                  |                     | A low number of streamlines                                       |
+------------------+---------------------+-------------------------------------------------------------------+
|      DWI         | Tract-profile       | Unexpected number of sections,                                    |
|                  |                     | Unbalanced sections                                               |
+------------------+---------------------+-------------------------------------------------------------------+
|    MTI, DWI      | Metrics map         | Unexpected range of value (FA > 1 for example),                   |
|                  |                     | Unexpected range of value in expected structure (low FA value in  |
|                  |                     | Corpus callosum for example)                                      |
+------------------+---------------------+-------------------------------------------------------------------+


Tools (usefull ?)
---------------

 - For DWI and T1 processing we used `Tractoflow`_
 - For DWI processing we used `NODDI Flow`_ and `Freewater Flow`_
 - For ihMT processing we used `ihMT Flow`_



 .. _Tractoflow: https://github.com/scilus/tractoflow

 .. _NODDI Flow: https://github.com/scilus/noddi_flow

 .. _Amico: https://github.com/daducci/AMICO

 .. _Freewater Flow: https://github.com/scilus/freewater_flow

 .. _ihMT Flow: https://github.com/scilus/ihmt_flow

 .. _RecobundlesX Flow: https://github.com/scilus/rbx_flow

 .. _DMRI QC Flow: https://github.com/scilus/dmriqc_flow

 .. _Nextflow: https://www.nextflow.io/

 .. _SCIL: http://scil.dinf.usherbrooke.ca/